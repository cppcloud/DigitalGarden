---
{"dg-publish":true,"permalink":"/Linux/07.å°† GDB ä¸å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºé…åˆä½¿ç”¨/","tags":["linux"]}
---

## åº”ç”¨ç¨‹åºæºä»£ç 

åˆ›å»ºä¸€ä¸ªå¤šçº¿ç¨‹åº”ç”¨ç¨‹åºå¹¶æ•è·äº†å…¶æ ¸å¿ƒè½¬å‚¨ï¼Œå¦‚ä½•ä½¿ç”¨ GDBã€‚

```c++
// Build:
// gcc main.c -pthread -static -o App1

#include <stdio.h>
#include <pthread.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>

#define THREAD_DECLARE(num) void bar_##num()\
{\
    sleep(-1);\
}\
\
void foo_##num()\
{\
    bar_##num();\
}\
\
void * thread_##num (void *arg)\
{\
    foo_##num();\
\
    return 0;\
}

THREAD_DECLARE(one)
THREAD_DECLARE(two)
THREAD_DECLARE(three)
THREAD_DECLARE(four)
THREAD_DECLARE(five)

#define THREAD_CREATE(num) {pthread_t threadID_##num; pthread_create (&threadID_##num, NULL, thread_##num, NULL);}

int main(int argc, const char * argv[])
{
    THREAD_CREATE(one)
    THREAD_CREATE(two)
    THREAD_CREATE(three)
    THREAD_CREATE(four)
    THREAD_CREATE(five)    
    
    sleep(-1);
    return 0;
}
```

## åŠ è½½æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶

åŠ è½½çš„æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶Â `App1.core.253`Â ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æ‰§è¡Œæ­¤æ“ä½œï¼š

```bash
gdb -c App1.core.253 -se App1
```

![Pasted image 20240702113254.png](/img/user/Linux/assert/Pasted%20image%2020240702113254.png)

## è®°å½• GDB è¾“å‡º

`logging`Â å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œç”¨äºå­˜å‚¨ GDB ä¼šè¯çš„æ‰€æœ‰è¾“å‡ºã€‚æœ€å¥½è®°å½•è¾“å‡ºä»¥ä¾›å°†æ¥åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚ä»¥ä¸‹å‘½ä»¤å°†ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ã€‚

```bash
set logging on App1.log
```

![Pasted image 20240702113348.png](/img/user/Linux/assert/Pasted%20image%2020240702113348.png)

## åˆ—å‡ºæ‰€æœ‰çº¿ç¨‹

`info threads`Â è¯¥å‘½ä»¤ä¸ºæˆ‘ä»¬æä¾›äº†å½“å‰åœ¨ç¯å¢ƒä¸­å·¥ä½œçš„çº¿ç¨‹çš„ç®€è¦æ‘˜è¦ã€‚

```bash
info threads
```

![Pasted image 20240702113437.png](/img/user/Linux/assert/Pasted%20image%2020240702113437.png)

## æ£€æŸ¥å †æ ˆè·Ÿè¸ª

```bash
bt
```

![Pasted image 20240702113507.png](/img/user/Linux/assert/Pasted%20image%2020240702113507.png)

å¦‚æœæˆ‘ä»¬æƒ³ä¸€æ¬¡æ€§è·å–æ‰€æœ‰çº¿ç¨‹çš„å †æ ˆè·Ÿè¸ªï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
thread apply all bt
```

![Pasted image 20240702113538.png](/img/user/Linux/assert/Pasted%20image%2020240702113538.png)

## åˆ‡æ¢çº¿ç¨‹

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ‡æ¢åˆ°Â `thread 2`Â å¹¶è·å–å…¶å †æ ˆè·Ÿè¸ªï¼š

```bash
thread 2

bt

info threads
```

![Pasted image 20240702113614.png](/img/user/Linux/assert/Pasted%20image%2020240702113614.png)

## åæ±‡ç¼–å‡½æ•°

æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†è°ƒç”¨å †æ ˆä¸Šçš„è¿”å›åœ°å€ä¸åæ±‡ç¼–è¾“å‡ºè¿›è¡Œæ¯”è¾ƒæ¥æ£€æŸ¥Â `bar_one`Â è°ƒç”¨äº†Â `sleep`Â å‡½æ•°ï¼š

```bash
disassemble bar_one
```

![Pasted image 20240702113649.png](/img/user/Linux/assert/Pasted%20image%2020240702113649.png)

æˆ‘ä»¬çœ‹åˆ°å‡½æ•°Â `bar_one`Â çš„å †æ ˆè·Ÿè¸ªä¸­çš„åœ°å€Â `0x0000000000401bbb`Â æ˜¯è°ƒç”¨Â `sleep`Â å‡½æ•°åè¦è¿”å›çš„åœ°å€ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ­¤åœ°å€é€šè¿‡ä»¥ä¸‹å‘½ä»¤åæ±‡ç¼–å‡½æ•°Â `bar_one`Â ï¼š

```bash
disassemble 0x0000000000401bbb
```

![Pasted image 20240702113750.png](/img/user/Linux/assert/Pasted%20image%2020240702113750.png)

å½“å‡½æ•°çš„åç§°æœªæ˜¾ç¤ºåœ¨å †æ ˆè·Ÿè¸ªä¸­æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚

## æ›´æ”¹åæ±‡ç¼–é£æ ¼

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ§åˆ¶ GDB å‘½ä»¤ä½¿ç”¨çš„åæ±‡ç¼–æ ·å¼ï¼š

```bash
set dissasembly-flavor <flavor>
```

æˆ‘ä»¬å¯ä»¥å°†Â `intel`Â æˆ– å‚æ•°Â `att`Â ä¼ é€’ç»™Â `set`Â å‘½ä»¤ã€‚è¯¥Â `att`Â å‚æ•°å¼ºåˆ¶ GDB ä½¿ç”¨åœ¨ Linux ç”¨æˆ·ä¸­æµè¡Œçš„ AT&T åæ±‡ç¼–æ ·å¼ï¼Œè€Œè¯¥Â `intel`Â å‚æ•°å°†åæ±‡ç¼–æ ·å¼æ›´æ”¹ä¸º Windows ç”¨æˆ·ä¸­æµè¡Œçš„ Intel æ ·å¼ã€‚

```bash
set disassembly-flavor intel

disassemble bar_two

set disassembly-flavor att
```

![Pasted image 20240702113903.png](/img/user/Linux/assert/Pasted%20image%2020240702113903.png)

## ä½¿ç”¨å†…å­˜æ˜ å°„

è¦æ£€æŸ¥æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºçš„æ•°æ®éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¯¥Â `pmap`Â å‘½ä»¤ä¸åº”ç”¨ç¨‹åºçš„ PID ä¸€èµ·ä½¿ç”¨ã€‚ä¸ºæ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å·²ç»æ•è·äº†å†…å­˜Â `App1`Â æ˜ å°„ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è¯¥æ˜ å°„ï¼š

```bash
cat App1.pmap.253
```

![Pasted image 20240702115025.png](/img/user/Linux/assert/Pasted%20image%2020240702115025.png)

æ³¨æ„ï¼šæ­¤æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡æ–°åŠ è½½æˆ‘ä»¬åœ¨ä¸Šä¸€ä¸ªä»»åŠ¡ä¸­åŠ è½½çš„æ ¸å¿ƒè½¬å‚¨ï¼š

```SHELL
gdbÂ -cÂ App1.core.253Â -seÂ App1
```

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸æ ¸å¿ƒè½¬å‚¨ä¸­å­˜åœ¨çš„éƒ¨åˆ†ä¿¡æ¯è¿›è¡Œæ¯”è¾ƒï¼š

```bash
maintenance info sections
```

![Pasted image 20240702115123.png](/img/user/Linux/assert/Pasted%20image%2020240702115123.png)

## è½¬å‚¨ç¬¦å·ä¿¡æ¯Â `.data`Â éƒ¨åˆ†

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è½¬å‚¨åŒ…å«å¯èƒ½çš„ç¬¦å·ä¿¡æ¯çš„éƒ¨åˆ†Â `.data`Â ï¼š

x/256a 0x004bf100

![Pasted image 20240702115156.png](/img/user/Linux/assert/Pasted%20image%2020240702115156.png)



æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¾“å‡ºçš„æ ¼å¼å¦‚ä¸‹ï¼š

`address: value1 value2`

ç”±äºæ¯ä¸ªå€¼çš„å¤§å°éƒ½æ˜¯Â 8å­—èŠ‚ï¼Œå› æ­¤é€šè¿‡æ·»åŠ å­—èŠ‚æˆ–Â 10â„ğ‘’ğ‘¥Â ä¸ä¸Šä¸€ä¸ªåœ°å€ç›¸åŠ Â 16Â æ¥è®¡ç®—ä¸‹ä¸€ä¸ªåœ°å€ã€‚

```
address <name> : value1 value2
```

æ¯ä¸ªå€¼è¿˜å¯ä»¥å…·æœ‰å…³è”çš„ç¬¦å·å€¼ï¼š

```
address <name> : value1 <name> value2 <name>
```

![Pasted image 20240702115653.png](/img/user/Linux/assert/Pasted%20image%2020240702115653.png)

æ³¨æ„ï¼šæˆ‘ä»¬çœ‹åˆ°å®‰è£…äº†é’©å­å‡½æ•°ï¼Œä½†æ²¡æœ‰Â `malloc`Â å®‰è£…ã€‚Â `memalign`Â æœ‰å…³æŒ‚é’©å‡½æ•°ï¼Œè¯·å‚é˜…ä»¥ä¸‹æ–‡æ¡£ã€‚

https://www.gnu.org/software/libc/manual/html_node/Hooks-for-Malloc.html

## æ¢ç´¢å†…å­˜å†…å®¹

æ¢è®¨ä¸€ä¸‹ __nptl_nthreads ã€ _nl_default_default_domain å’Œå…¶ä»–ä¸€äº›åœ°å€æ‰€æŒ‡å‘çš„å†…å­˜å†…å®¹ã€‚

>æ³¨æ„ï¼šÂ `/u`Â ç”¨äºæ— ç¬¦å·å°æ•°ï¼ŒÂ `/g`Â ç”¨äº 64 ä½å€¼ï¼ŒÂ `/a`Â ç”¨äºåœ°å€ï¼ŒÂ `/c`Â å¹¶ä¸”ç”¨äºÂ `/s`Â å­—ç¬¦å’Œå­—ç¬¦ä¸²ã€‚

```bash
x/u 0x4bf110

x/u &__nptl_nthreads

x/2a 0x4bf160

x/a &_nl_default_default_domain

x/a 0x494a88

x/s 0x494a88

x/10a 0x494a88

x/8c 0x494a88

x/10s 0x494a88
```


![Pasted image 20240702122132.png](/img/user/Linux/assert/Pasted%20image%2020240702122132.png)

## æ¢ç´¢ç¯å¢ƒå˜é‡

æ¢è®¨Â `environ`Â å˜é‡åœ°å€æ‰€æŒ‡å‘çš„å†…å­˜å†…å®¹ï¼š

```bash
x/a &environ

x/10a 0x7ffdf45637f8

x/10s 0x7ffdf4565756
```

![Pasted image 20240702122214.png](/img/user/Linux/assert/Pasted%20image%2020240702122214.png)

## å†…å­˜æœç´¢

ç°åœ¨ï¼Œæˆ‘ä»¬çœ‹çœ‹å¦‚ä½•æ‰§è¡Œå†…å­˜æœç´¢ã€‚æ— æ³•åœ¨æ•´ä¸ªè™šæ‹Ÿå†…å­˜ä¸­æœç´¢ï¼Œåªèƒ½åœ¨æœ‰æ•ˆåŒºåŸŸä¸­æœç´¢ï¼ˆé”®å…¥Â `help find`Â æœ‰å…³Â `find`Â å‘½ä»¤çš„è¯¦ç»†ä¿¡æ¯ï¼‰ã€‚

```bash
find /g 0x004bc000, 0x004d2000, 6

x/g 0x4bf110

x/s 0x7ffdf4565756

find 0x7ffdf4565756, +100, "bash"
```

![Pasted image 20240702122258.png](/img/user/Linux/assert/Pasted%20image%2020240702122258.png)

è¯¥Â `bash`Â æ•°ç»„è¢«è§†ä¸ºä»¥ç©ºç»“å°¾çš„å­—ç¬¦æ•°ç»„ï¼Œç”¨äºæœç´¢ã€‚è‹¥è¦æœç´¢ä¸å¸¦ null ç»ˆæ­¢ç¬¦çš„å­—ç¬¦ä¸²åºåˆ—ï¼Œè¯·ä½¿ç”¨å­—ç¬¦åºåˆ—ï¼š

```bash
find 0x7ffdf4565756, +100, "bin"

find 0x7ffdf4565756, +100, 'b', 'i', 'n'
```

![Pasted image 20240702122332.png](/img/user/Linux/assert/Pasted%20image%2020240702122332.png)

## è·å–å·²åŠ è½½æ¨¡å—çš„åˆ—è¡¨

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è·å–åŠ è½½æ¨¡å—çš„åˆ—è¡¨ï¼š

```bash
info sharedlibrary
```

![Pasted image 20240702122418.png](/img/user/Linux/assert/Pasted%20image%2020240702122418.png)

æˆ‘ä»¬æ²¡æœ‰çœ‹åˆ°ä»»ä½•å…±äº«åº“ï¼Œå› ä¸ºå®ƒä»¬æ˜¯é™æ€é“¾æ¥çš„ã€‚

æˆ‘ä»¬è¿˜åˆ›å»ºäº†ä¸€ä¸ªåŠ¨æ€é“¾æ¥Â `App1.shared`Â çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚å¦‚æœæˆ‘ä»¬åŠ è½½å…¶æ ¸å¿ƒè½¬å‚¨Â `App1.shared.core.38`Â ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°å…±äº«åº“çš„åˆ—è¡¨ï¼š

```bash
quit

gdb -c App1.shared.core.38 -se App1.shared
```

![Pasted image 20240702122457.png](/img/user/Linux/assert/Pasted%20image%2020240702122457.png)

## ä»¥ä¸‹å‡½æ•°è°ƒç”¨

å°†åæ±‡ç¼–è¯¥Â `bar_one`Â å‡½æ•°å¹¶éµå¾ªé—´æ¥ç¡çœ å‡½æ•°è°ƒç”¨ï¼š

```bash
disassemble bar_one

disassemble 0x55dc8e814090
```

![Pasted image 20240702122533.png](/img/user/Linux/assert/Pasted%20image%2020240702122533.png)

## å°†æ‰¹æ³¨å€¼è½¬å‚¨ä¸ºå†…å­˜åœ°å€

å¯ä»¥å°†å¸¦æ³¨é‡Šçš„å€¼è½¬å‚¨ä¸ºå†…å­˜åœ°å€ï¼Œå°†å…¶å†…å®¹è§£é‡Šä¸ºç¬¦å·ï¼š

```
x/a 0x55dc8e816fd0
```

![Pasted image 20240702122640.png](/img/user/Linux/assert/Pasted%20image%2020240702122640.png)

## åº“åŒºåŸŸï¼ˆLibrary regionsï¼‰

å¯ä»¥é€šè¿‡ä½¿ç”¨Â `App1.shared.pmap.38`Â å¸¦æœ‰æ–‡ä»¶Â `cat`Â çš„å‘½ä»¤æ¥æŸ¥çœ‹åº“å†…å­˜åŒºåŸŸã€‚ä½†æ˜¯ï¼Œåœ¨æ‰§è¡Œæ­¤æ“ä½œä¹‹å‰ï¼Œæˆ‘ä»¬å°†Â `gdb`Â é€€å‡ºè¯¥Â `q`Â å‘½ä»¤ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦å®ƒã€‚

```bash
q

cat App1.shared.pmap.38
```

![Pasted image 20240702122746.png](/img/user/Linux/assert/Pasted%20image%2020240702122746.png)